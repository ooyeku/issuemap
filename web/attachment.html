<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Attachment Viewer - IssueMap</title>
  <link rel="stylesheet" href="/styles.css" />
  <!-- Marked.js for Markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" onerror="console.warn('Failed to load marked.js from CDN')"></script>
  <!-- PDF.js for PDF rendering -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" onerror="console.warn('Failed to load PDF.js from CDN')"></script>
  <script>
    // Configure PDF.js worker (only if PDF.js loaded successfully)
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
  </script>
  <style>
    .attachment-viewer {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 2rem;
    }
    .viewer-header {
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }
    .viewer-content {
      margin: 2rem 0;
      padding: 2rem;
      background: var(--bg-secondary);
      border-radius: 8px;
      min-height: 400px;
    }
    .image-preview {
      text-align: center;
    }
    .image-preview img {
      max-width: 100%;
      height: auto;
      border: 1px solid var(--border);
      border-radius: 4px;
    }
    .text-preview {
      white-space: pre-wrap;
      font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
      line-height: 1.5;
      overflow-x: auto;
    }
    .download-section {
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 1px solid var(--border);
    }
    .metadata-grid {
      display: grid;
      grid-template-columns: 150px 1fr;
      gap: 0.5rem 1rem;
      margin-top: 1rem;
    }
    .metadata-grid .key {
      font-weight: 600;
      color: var(--text-secondary);
    }
    .no-preview {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--muted);
      background: var(--panel);
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    .back-link {
      display: inline-block;
      margin-bottom: 1rem;
    }
    
    /* PDF Viewer Styles */
    .pdf-viewer {
      background: #525659;
      border-radius: 8px;
      padding: 1rem;
      min-height: 600px;
    }
    .pdf-controls {
      display: flex;
      gap: 1rem;
      align-items: center;
      justify-content: center;
      margin-bottom: 1rem;
      padding: 0.5rem;
      background: var(--panel);
      border-radius: 6px;
    }
    .pdf-controls button {
      padding: 0.5rem 1rem;
      background: var(--accent);
      color: #06101a;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
    }
    .pdf-controls button:hover {
      filter: brightness(1.1);
    }
    .pdf-controls button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .pdf-page-info {
      color: var(--text);
      font-size: 14px;
    }
    #pdfCanvas {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 0 auto;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    /* Markdown Viewer Styles */
    .markdown-preview {
      max-width: none;
      padding: 2rem;
      line-height: 1.6;
      color: var(--text);
      background: var(--panel);
      border-radius: 8px;
    }
    .markdown-preview h1,
    .markdown-preview h2,
    .markdown-preview h3,
    .markdown-preview h4,
    .markdown-preview h5,
    .markdown-preview h6 {
      color: var(--accent);
      margin-top: 1.5em;
      margin-bottom: 0.5em;
      font-weight: 600;
    }
    .markdown-preview h1 {
      font-size: 2em;
      border-bottom: 2px solid var(--border);
      padding-bottom: 0.3em;
    }
    .markdown-preview h2 {
      font-size: 1.5em;
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.3em;
    }
    .markdown-preview h3 {
      font-size: 1.25em;
    }
    .markdown-preview p {
      margin: 1em 0;
    }
    .markdown-preview pre {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 1rem;
      overflow-x: auto;
      margin: 1em 0;
    }
    .markdown-preview code {
      background: var(--bg-secondary);
      padding: 0.2em 0.4em;
      border-radius: 3px;
      font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Consolas', monospace;
      font-size: 0.9em;
    }
    .markdown-preview pre code {
      background: none;
      padding: 0;
      font-size: 0.9em;
    }
    .markdown-preview blockquote {
      border-left: 4px solid var(--accent);
      margin: 1em 0;
      padding-left: 1em;
      color: var(--muted);
      font-style: italic;
    }
    .markdown-preview ul,
    .markdown-preview ol {
      margin: 1em 0;
      padding-left: 2em;
    }
    .markdown-preview li {
      margin: 0.5em 0;
    }
    .markdown-preview table {
      border-collapse: collapse;
      width: 100%;
      margin: 1em 0;
    }
    .markdown-preview th,
    .markdown-preview td {
      border: 1px solid var(--border);
      padding: 0.5em;
      text-align: left;
    }
    .markdown-preview th {
      background: var(--bg-secondary);
      font-weight: 600;
    }
    .markdown-preview img {
      max-width: 100%;
      height: auto;
      border-radius: 4px;
    }
    .markdown-preview a {
      color: var(--accent);
      text-decoration: none;
    }
    .markdown-preview a:hover {
      text-decoration: underline;
    }
    .markdown-preview hr {
      border: none;
      border-top: 1px solid var(--border);
      margin: 2em 0;
    }
  </style>
</head>
<body>
  <header class="app-header">
    <div class="brand">
      <div class="logo">IM</div>
      <div class="titles">
        <h1>Attachment Viewer</h1>
        <div class="subtitle">IssueMap File Attachment</div>
      </div>
    </div>
  </header>

  <main class="attachment-viewer">
    <a href="/" class="action-link back-link" id="backLink">‚Üê Back to Issue</a>
    
    <div class="viewer-header">
      <h2 id="fileName">Loading...</h2>
      <div class="metadata-grid" id="metadata"></div>
    </div>

    <div class="viewer-content" id="viewerContent">
      <div class="no-preview">Loading attachment...</div>
    </div>

    <div class="download-section">
      <a id="downloadBtn" class="btn" href="#" download>Download File</a>
      <button id="deleteBtn" class="btn" style="background: var(--danger); margin-left: 12px;">Delete Attachment</button>
    </div>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    (function() {
      const $ = sel => document.querySelector(sel);
      const API_BASE = '/api/v1';

      function toast(msg) {
        const t = $('#toast');
        if (!t) return;
        t.textContent = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2000);
      }

      function escapeHtml(str) {
        return String(str || '').replace(/[&<>"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
      }

      async function loadAttachment() {
        const params = new URLSearchParams(location.search);
        const id = params.get('id');
        const issueId = params.get('issue');
        
        // Set the back link
        const backLink = $('#backLink');
        if (issueId) {
          backLink.href = `/#${encodeURIComponent(issueId)}`;
        } else {
          backLink.href = '/';
        }
        
        if (!id) {
          $('#fileName').textContent = 'No attachment ID provided';
          $('#viewerContent').innerHTML = '<div class="no-preview">Invalid attachment ID</div>';
          return;
        }

        try {
          // Fetch attachment metadata
          const r = await fetch(`${API_BASE}/attachments/${encodeURIComponent(id)}`);
          if (!r.ok) throw new Error('Failed to load attachment');
          
          const data = await r.json();
          if (!data.success) throw new Error('Failed to load attachment data');
          
          const att = data.data;
          
          // Update header
          $('#fileName').textContent = att.filename;
          document.title = `${att.filename} - IssueMap`;
          
          // Update metadata
          const metaGrid = $('#metadata');
          metaGrid.innerHTML = `
            <div class="key">Type:</div><div>${escapeHtml(att.type)}</div>
            <div class="key">Size:</div><div>${escapeHtml(att.size_formatted)}</div>
            <div class="key">Content Type:</div><div>${escapeHtml(att.content_type)}</div>
            <div class="key">Uploaded By:</div><div>${escapeHtml(att.uploaded_by)}</div>
            <div class="key">Uploaded At:</div><div>${new Date(att.uploaded_at).toLocaleString()}</div>
            ${att.description ? `<div class="key">Description:</div><div>${escapeHtml(att.description)}</div>` : ''}
          `;
          
          // Update download button
          const downloadBtn = $('#downloadBtn');
          downloadBtn.href = `${API_BASE}/attachments/${encodeURIComponent(id)}/download`;
          downloadBtn.download = att.filename;
          
          // Setup delete button
          const deleteBtn = $('#deleteBtn');
          if (deleteBtn) {
            deleteBtn.addEventListener('click', async () => {
              if (confirm(`Are you sure you want to delete "${att.filename}"?`)) {
                try {
                  const response = await fetch(`${API_BASE}/attachments/${encodeURIComponent(id)}`, {
                    method: 'DELETE'
                  });
                  
                  if (response.ok) {
                    toast('Attachment deleted successfully');
                    // Redirect back to issue after successful deletion
                    setTimeout(() => {
                      if (issueId) {
                        window.location.href = `/#${encodeURIComponent(issueId)}`;
                      } else {
                        window.location.href = '/';
                      }
                    }, 1000);
                  } else {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    toast('Delete failed: ' + (errorData.error || 'Unknown error'));
                  }
                } catch (error) {
                  console.error('Delete error:', error);
                  toast('Network error during delete');
                }
              }
            });
          }
          
          // Show preview based on type
          const viewerContent = $('#viewerContent');
          
          if (att.type === 'image') {
            // Show image preview
            viewerContent.innerHTML = `
              <div class="image-preview">
                <img src="${API_BASE}/attachments/${encodeURIComponent(id)}/download" alt="${escapeHtml(att.filename)}">
              </div>
            `;
          } else if (att.type === 'document' && (att.content_type === 'application/pdf' || att.filename.toLowerCase().endsWith('.pdf'))) {
            // Show PDF preview using PDF.js
            viewerContent.innerHTML = `
              <div class="pdf-viewer">
                <div class="pdf-controls">
                  <button id="prevPage">Previous</button>
                  <span class="pdf-page-info">
                    Page <span id="pageNum">1</span> of <span id="pageCount">1</span>
                  </span>
                  <button id="nextPage">Next</button>
                  <button id="zoomOut">Zoom Out</button>
                  <button id="zoomIn">Zoom In</button>
                </div>
                <canvas id="pdfCanvas"></canvas>
              </div>
            `;
            
            // Load and render PDF
            const pdfUrl = `${API_BASE}/attachments/${encodeURIComponent(id)}/download`;
            let pdfDoc = null;
            let pageNum = 1;
            let pageRendering = false;
            let pageNumPending = null;
            let scale = 1.5;
            
            async function renderPage(num) {
              pageRendering = true;
              try {
                const page = await pdfDoc.getPage(num);
                const canvas = document.getElementById('pdfCanvas');
                const ctx = canvas.getContext('2d');
                
                // Calculate scale based on container width for responsiveness
                const containerWidth = canvas.parentElement.clientWidth - 40; // Account for padding
                const viewport = page.getViewport({ scale: 1.0 });
                const calculatedScale = Math.min(scale, containerWidth / viewport.width);
                
                const scaledViewport = page.getViewport({ scale: calculatedScale });
                canvas.height = scaledViewport.height;
                canvas.width = scaledViewport.width;
                
                const renderContext = {
                  canvasContext: ctx,
                  viewport: scaledViewport
                };
                await page.render(renderContext).promise;
                pageRendering = false;
                
                if (pageNumPending !== null) {
                  renderPage(pageNumPending);
                  pageNumPending = null;
                }
              } catch (e) {
                console.error('Error rendering page:', e);
                pageRendering = false;
              }
              
              // Update page info
              document.getElementById('pageNum').textContent = num;
              
              // Update button states
              document.getElementById('prevPage').disabled = (num <= 1);
              document.getElementById('nextPage').disabled = (num >= pdfDoc.numPages);
            }
            
            function queueRenderPage(num) {
              if (pageRendering) {
                pageNumPending = num;
              } else {
                renderPage(num);
              }
            }
            
            function onPrevPage() {
              if (pageNum <= 1) return;
              pageNum--;
              queueRenderPage(pageNum);
            }
            
            function onNextPage() {
              if (pageNum >= pdfDoc.numPages) return;
              pageNum++;
              queueRenderPage(pageNum);
            }
            
            function onZoomIn() {
              scale = scale * 1.25;
              queueRenderPage(pageNum);
            }
            
            function onZoomOut() {
              scale = scale * 0.8;
              queueRenderPage(pageNum);
            }
            
            // Check if PDF.js is loaded
            if (typeof pdfjsLib === 'undefined') {
              viewerContent.innerHTML = '<div class="no-preview">PDF.js library not loaded. Please check your internet connection.</div>';
              return;
            }
            
            // Load PDF document
            pdfjsLib.getDocument(pdfUrl).promise.then(function(pdf) {
              pdfDoc = pdf;
              document.getElementById('pageCount').textContent = pdf.numPages;
              renderPage(pageNum);
              
              // Set up event listeners
              document.getElementById('prevPage').addEventListener('click', onPrevPage);
              document.getElementById('nextPage').addEventListener('click', onNextPage);
              document.getElementById('zoomIn').addEventListener('click', onZoomIn);
              document.getElementById('zoomOut').addEventListener('click', onZoomOut);
            }).catch(function(error) {
              console.error('Error loading PDF:', error);
              viewerContent.innerHTML = '<div class="no-preview">Unable to load PDF preview</div>';
            });
            
          } else if (att.type === 'text' && (att.filename.toLowerCase().endsWith('.md') || 
                     att.filename.toLowerCase().endsWith('.markdown') || 
                     att.content_type === 'text/markdown')) {
            // Show Markdown preview
            try {
              // Check if marked.js is loaded
              if (typeof marked === 'undefined') {
                viewerContent.innerHTML = '<div class="no-preview">Marked.js library not loaded. Please check your internet connection.</div>';
                return;
              }
              
              const contentR = await fetch(`${API_BASE}/attachments/${encodeURIComponent(id)}/download`);
              if (contentR.ok) {
                const markdownText = await contentR.text();
                
                // Configure marked options
                marked.setOptions({
                  gfm: true,
                  breaks: true,
                  headerIds: true,
                  mangle: false,
                  sanitize: false
                });
                
                // Convert markdown to HTML
                const htmlContent = marked(markdownText);
                viewerContent.innerHTML = `<div class="markdown-preview">${htmlContent}</div>`;
              } else {
                viewerContent.innerHTML = '<div class="no-preview">Unable to load markdown preview</div>';
              }
            } catch (e) {
              console.error('Error loading markdown:', e);
              viewerContent.innerHTML = '<div class="no-preview">Unable to load markdown preview</div>';
            }
          } else if (att.type === 'text' || att.content_type.startsWith('text/')) {
            // Load and show text content
            try {
              const contentR = await fetch(`${API_BASE}/attachments/${encodeURIComponent(id)}/download`);
              if (contentR.ok) {
                const text = await contentR.text();
                viewerContent.innerHTML = `<div class="text-preview">${escapeHtml(text)}</div>`;
              } else {
                viewerContent.innerHTML = '<div class="no-preview">Unable to load text preview</div>';
              }
            } catch (e) {
              viewerContent.innerHTML = '<div class="no-preview">Unable to load text preview</div>';
            }
          } else {
            // No preview available
            viewerContent.innerHTML = `
              <div class="no-preview">
                <p>Preview not available for ${escapeHtml(att.type)} files</p>
                <p>File: ${escapeHtml(att.filename)}</p>
                <p>Size: ${escapeHtml(att.size_formatted)}</p>
              </div>
            `;
          }
          
        } catch (e) {
          toast('Failed to load attachment');
          $('#fileName').textContent = 'Error loading attachment';
          $('#viewerContent').innerHTML = '<div class="no-preview">Failed to load attachment</div>';
        }
      }

      // Load on page load
      loadAttachment();
    })();
  </script>
</body>
</html>